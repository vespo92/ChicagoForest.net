# Chicago Forest Network Gateway - Kubernetes Deployment
#
# DISCLAIMER: This is part of an AI-generated theoretical framework
# for educational and research purposes. The Chicago Forest Network
# is a conceptual project exploring decentralized energy networks.
#
# The Gateway provides:
# - NAT for internet access
# - DHCP for LAN clients
# - DNS resolution
# - Traffic routing between Forest mesh and external networks
#
# Deploy: kubectl apply -f gateway-service.yaml
# Note: Gateway typically requires host networking and elevated privileges

---
# =============================================================================
# ConfigMap - Gateway Configuration
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: forest-gateway-config
  namespace: chicago-forest
  labels:
    app.kubernetes.io/name: forest-gateway
    app.kubernetes.io/component: config
data:
  # Gateway mode
  GATEWAY_MODE: "true"

  # Network interfaces
  WAN_INTERFACE: "eth0"
  FOREST_INTERFACE: "net1"
  LAN_INTERFACE: "eth2"

  # NAT configuration
  ENABLE_NAT: "true"
  NAT_INTERFACE: "eth0"

  # DHCP configuration
  ENABLE_DHCP: "true"
  DHCP_RANGE_START: "10.42.1.100"
  DHCP_RANGE_END: "10.42.1.200"
  DHCP_LEASE_TIME: "12h"
  DHCP_DOMAIN: "forest.local"

  # DNS configuration
  ENABLE_DNS: "true"
  DNS_UPSTREAM: "1.1.1.1,8.8.8.8"
  DNS_LOCAL_DOMAIN: "forest.local"

  # Subnets
  FOREST_SUBNET: "10.42.0.0/16"
  LAN_SUBNET: "192.168.42.0/24"

  # Features
  ENABLE_FIREWALL: "true"
  ENABLE_TRAFFIC_SHAPING: "false"
  ENABLE_VPN_SERVER: "true"

  # Logging
  LOG_LEVEL: "info"

---
# =============================================================================
# ConfigMap - DNSMasq Configuration
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: forest-gateway-dnsmasq
  namespace: chicago-forest
  labels:
    app.kubernetes.io/name: forest-gateway
    app.kubernetes.io/component: dnsmasq-config
data:
  dnsmasq.conf: |
    # Chicago Forest Network Gateway - DNSMasq Configuration
    # Auto-generated - Modify via ConfigMap

    # DNS Settings
    port=53
    domain-needed
    bogus-priv
    no-resolv
    server=1.1.1.1
    server=8.8.8.8

    # Local domain
    local=/forest.local/
    domain=forest.local
    expand-hosts

    # DHCP Settings
    dhcp-range=10.42.1.100,10.42.1.200,12h
    dhcp-option=option:router,10.42.1.1
    dhcp-option=option:dns-server,10.42.1.1
    dhcp-option=option:domain-name,forest.local
    dhcp-option=option:ntp-server,10.42.1.1

    # Static leases (add as needed)
    # dhcp-host=aa:bb:cc:dd:ee:ff,10.42.1.10,gateway

    # Logging
    log-queries
    log-dhcp

    # Cache
    cache-size=1000

    # Security
    stop-dns-rebind
    rebind-localhost-ok

---
# =============================================================================
# ConfigMap - IPTables Rules
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: forest-gateway-iptables
  namespace: chicago-forest
  labels:
    app.kubernetes.io/name: forest-gateway
    app.kubernetes.io/component: iptables-config
data:
  iptables-rules.sh: |
    #!/bin/bash
    # Chicago Forest Network Gateway - IPTables Rules
    # DISCLAIMER: Theoretical configuration for educational purposes

    set -e

    # Variables from environment
    WAN_IF="${WAN_INTERFACE:-eth0}"
    FOREST_IF="${FOREST_INTERFACE:-net1}"
    LAN_IF="${LAN_INTERFACE:-eth2}"
    FOREST_SUBNET="${FOREST_SUBNET:-10.42.0.0/16}"
    LAN_SUBNET="${LAN_SUBNET:-192.168.42.0/24}"

    echo "Configuring firewall..."
    echo "WAN: $WAN_IF, FOREST: $FOREST_IF, LAN: $LAN_IF"

    # Flush existing rules
    iptables -F
    iptables -X
    iptables -t nat -F
    iptables -t nat -X
    iptables -t mangle -F
    iptables -t mangle -X

    # Default policies
    iptables -P INPUT DROP
    iptables -P FORWARD DROP
    iptables -P OUTPUT ACCEPT

    # Loopback
    iptables -A INPUT -i lo -j ACCEPT
    iptables -A OUTPUT -o lo -j ACCEPT

    # Established connections
    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
    iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

    # ICMP
    iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
    iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT

    # Forest mesh interface - allow all
    iptables -A INPUT -i "$FOREST_IF" -j ACCEPT
    iptables -A FORWARD -i "$FOREST_IF" -j ACCEPT

    # LAN interface - allow all
    if ip link show "$LAN_IF" > /dev/null 2>&1; then
        iptables -A INPUT -i "$LAN_IF" -j ACCEPT
        iptables -A FORWARD -i "$LAN_IF" -o "$WAN_IF" -j ACCEPT
        iptables -A FORWARD -i "$LAN_IF" -o "$FOREST_IF" -j ACCEPT
    fi

    # WAN interface - services
    iptables -A INPUT -i "$WAN_IF" -p udp --dport 51820 -j ACCEPT  # WireGuard
    iptables -A INPUT -i "$WAN_IF" -p udp --dport 42000 -j ACCEPT  # P2P

    # NAT - Masquerade for internet access
    iptables -t nat -A POSTROUTING -o "$WAN_IF" -j MASQUERADE

    # Forward from Forest to WAN
    iptables -A FORWARD -i "$FOREST_IF" -o "$WAN_IF" -j ACCEPT

    # DNS (from LAN/Forest only)
    iptables -A INPUT -i "$FOREST_IF" -p udp --dport 53 -j ACCEPT
    iptables -A INPUT -i "$FOREST_IF" -p tcp --dport 53 -j ACCEPT

    # DHCP (LAN interface only)
    if ip link show "$LAN_IF" > /dev/null 2>&1; then
        iptables -A INPUT -i "$LAN_IF" -p udp --dport 67:68 -j ACCEPT
    fi

    # API (internal only)
    iptables -A INPUT -i "$FOREST_IF" -p tcp --dport 8080 -j ACCEPT
    iptables -A INPUT -i "$LAN_IF" -p tcp --dport 8080 -j ACCEPT 2>/dev/null || true

    # Logging dropped packets
    iptables -A INPUT -j LOG --log-prefix "IPT-INPUT-DROP: " --log-level 4
    iptables -A FORWARD -j LOG --log-prefix "IPT-FORWARD-DROP: " --log-level 4

    echo "Firewall configuration complete"

---
# =============================================================================
# Secret - Gateway Keys
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: forest-gateway-keys
  namespace: chicago-forest
  labels:
    app.kubernetes.io/name: forest-gateway
    app.kubernetes.io/component: secrets
type: Opaque
data:
  # Replace with actual base64-encoded keys
  wireguard-private-key: ""
  vpn-server-key: ""

---
# =============================================================================
# PersistentVolumeClaim - Gateway Data
# =============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: forest-gateway-data
  namespace: chicago-forest
  labels:
    app.kubernetes.io/name: forest-gateway
    app.kubernetes.io/component: storage
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
  storageClassName: standard

---
# =============================================================================
# DaemonSet - Gateway (one per node with gateway label)
# =============================================================================
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: forest-gateway
  namespace: chicago-forest
  labels:
    app.kubernetes.io/name: forest-gateway
    app.kubernetes.io/component: gateway
    app.kubernetes.io/version: "0.1.0"
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: forest-gateway
      app.kubernetes.io/component: gateway
  template:
    metadata:
      labels:
        app.kubernetes.io/name: forest-gateway
        app.kubernetes.io/component: gateway
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
    spec:
      # Only deploy on nodes labeled as gateways
      nodeSelector:
        node-role.kubernetes.io/forest-gateway: "true"

      # Host networking required for gateway functionality
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet

      # Tolerations
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "forest-gateway"
          effect: "NoSchedule"

      serviceAccountName: forest-node

      # Init container - setup iptables
      initContainers:
        - name: init-firewall
          image: alpine:3.19
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache iptables ip6tables
              # Enable IP forwarding
              sysctl -w net.ipv4.ip_forward=1
              sysctl -w net.ipv6.conf.all.forwarding=1
              # Run iptables setup
              /scripts/iptables-rules.sh
          securityContext:
            privileged: true
          volumeMounts:
            - name: iptables-scripts
              mountPath: /scripts
              readOnly: true

      containers:
        - name: gateway
          image: ghcr.io/chicago-forest/forest-gateway:latest
          imagePullPolicy: Always

          envFrom:
            - configMapRef:
                name: forest-gateway-config

          env:
            - name: FOREST_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: WIREGUARD_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: forest-gateway-keys
                  key: wireguard-private-key
                  optional: true

          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
                - NET_RAW
                - SYS_MODULE
                - SYS_ADMIN

          resources:
            requests:
              cpu: "1"
              memory: "1Gi"
            limits:
              cpu: "4"
              memory: "4Gi"

          ports:
            - name: dns-udp
              containerPort: 53
              hostPort: 53
              protocol: UDP
            - name: dns-tcp
              containerPort: 53
              hostPort: 53
              protocol: TCP
            - name: dhcp
              containerPort: 67
              hostPort: 67
              protocol: UDP
            - name: p2p
              containerPort: 42000
              hostPort: 42000
              protocol: UDP
            - name: wireguard
              containerPort: 51820
              hostPort: 51820
              protocol: UDP
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: metrics
              containerPort: 9090
              protocol: TCP

          volumeMounts:
            - name: gateway-data
              mountPath: /var/lib/forest
            - name: dnsmasq-config
              mountPath: /etc/dnsmasq.d
            - name: wireguard-config
              mountPath: /etc/wireguard
            - name: tun-device
              mountPath: /dev/net/tun

          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10

          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10

        # Sidecar - DNSMasq
        - name: dnsmasq
          image: alpine:3.19
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache dnsmasq
              dnsmasq -k --conf-file=/etc/dnsmasq.d/dnsmasq.conf
          securityContext:
            capabilities:
              add:
                - NET_BIND_SERVICE
                - NET_ADMIN
          volumeMounts:
            - name: dnsmasq-config
              mountPath: /etc/dnsmasq.d
          resources:
            requests:
              cpu: "100m"
              memory: "64Mi"
            limits:
              cpu: "500m"
              memory: "256Mi"

      volumes:
        - name: gateway-data
          persistentVolumeClaim:
            claimName: forest-gateway-data
        - name: dnsmasq-config
          configMap:
            name: forest-gateway-dnsmasq
        - name: iptables-scripts
          configMap:
            name: forest-gateway-iptables
            defaultMode: 0755
        - name: wireguard-config
          emptyDir: {}
        - name: tun-device
          hostPath:
            path: /dev/net/tun
            type: CharDevice

---
# =============================================================================
# Service - Gateway Internal
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: forest-gateway
  namespace: chicago-forest
  labels:
    app.kubernetes.io/name: forest-gateway
    app.kubernetes.io/component: service
spec:
  type: ClusterIP
  clusterIP: None  # Headless service
  selector:
    app.kubernetes.io/name: forest-gateway
    app.kubernetes.io/component: gateway
  ports:
    - name: http
      port: 8080
      protocol: TCP
    - name: metrics
      port: 9090
      protocol: TCP
    - name: dns-udp
      port: 53
      protocol: UDP
    - name: dns-tcp
      port: 53
      protocol: TCP
